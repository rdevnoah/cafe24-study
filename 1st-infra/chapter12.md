## Chapter12 확장성 확보에 필요한 사고방식 <sub>규모 증대와 시스템 확장</sub>

> 규모 증대에 따라 시스템을 얼마나 확장해서 대응할 수 있도록 해둘 것인지에 대해 살펴보도록 한다. 또한 실제 시스템 구축 자체를 목적으로 하는 것은 아니므로 확장성 확보에 필요한 사고방식을 위주로 설명한다.



#### 확장성에 대한 요구 <sub>서버 1대에서 처리할 수 있는 트래픽 한계</sub>

- 기본 4 Core 의 CPU와 8GB의 RAM을 가지고 있다면 100만PV(page view)/월 정도 나온다. 
- 만일 4 Core CPU X 2, 32GB의 RAM이라면 200만PV/월이다.



하지만 서비스의 규모가 커져 만일 수억 PV/월 이라면 서버 한대로는 도저히 감당할 수 없다. 따라서 아래에서부터는 계층별로 확장성을 살펴보도록 한다.



#### 계층별 확장성

- AP 서버는 시본적으로 그다지 깊은 부분까지 생각하지 않아도 비교적 간단하게 확장이 가능하다. 요청별로 다른 AP서버로 날려보내도 처리상 문제가 되지 않고, **로드밸런서** 만 잘 구축되어있다면, 서버를 추가하기만 하면 확장성을 확보할 수 있다. 

- 하지만 DB나 파일서버의 경우 분산, 확장성 확보가 어렵다. 

  - 데이터로의 요청은 Read, Write 두가지로 나뉘는데, Read의 경우 비교적 용이한 반면 **Write**의 경우 매우 어렵다.

    > Read의 경우 데이터에 변화가 이뤄지지 않지만, Write의 경우 데이터의 수정이나 삭제, 추가가 이뤄진다. 이 경우 분산이나 확장했을 때, 각 서버 간의 sync를 맞추는 작업이 추가로 필요하다.



#### 부하파악 

어느 부분을 어떻게 확장할 것인지를 검토하기 위해서는 부하가 이뤄지는 곳을 정확히 파악하고 있는 것이 중요하다. 

> 개발자에게 있어 섣부른 판단이나 예측, 추측은 위험하다. 항상 정확한 분석이 필요하다.

인프라에 있어서는 부하를 파악하는 툴을 주로 사용한다. Cafe24의 인프라에서도 서버별로 상황을 파악할 수 있는 그래프 툴을 보여주신 적 있는데, 대충 눈으로 본 것만으로 각 서버(WAS, DB, Cache)들의 부하정보를 일,월 등등으로 한눈에 파악할 수 있도록 되어있다. 

- 부하를 측정하기 위한 항목
  - Load Average의 경우 chapter2에서도 잠깐 다루었지만 일단 가장 먼저 확인하는 것이 좋다. 커널 내에서 동작하는 다수의 프로세스들 중 대기중인 프로세스들의 비율을 확인할 수 있기 때문이다. 대기중이라는 것은 그만큼 스펙 오버해서 사용중(혹은 이 후 파악해야할 문제로 인해 발생한 것) 이라 확장이 필요하다는 것을 결정할 수 있기 때문이다. 
  - 일반적으로는 Load Average는 서비스의 용도에 따라 CPU의 50%정도는 여유롭게 사용하기도 하고, 일부러 높게 하는 곳도 존재한다.

#### 용도에 맞는 튜닝 - 사용자용 서버, 봇용 서버

- 서버를 확장하고 서비스에 맞도록 튜닝하는 작업도 효율성을 위해 용도에 따라 분리하기도 한다. 하테나의 예시에서는 사용자용과 크롤러 등의 봇용 요청을 각각 처리하는 서버를 분산하였다(chapter3 참고). 봇의 요청의 경우 응답시간이 그리 중요하지 않기 때문에 요청 처리수를 최대화 하는 방향으로 튜닝한다. 따라서 Load Average도 높게 나타난다. 하지만 사용자의 경우 Load Average를 최대한 낮추는 방식으로 유지되고 있으며, 리소스를 즉각적으로 소진하기 보다는 여유분을 두어 처리대기 프로세스를 쌓아두지 않는 방향으로 튜닝한다. 

  > 봇과 사용자를 분리함에 따라 AP 서버의 튜닝 정책을 변경해서 그 효율을 중시할지, 응답시간을 중시할지, 아니면 리소스를 최대한 사용하는 것을 중시하는 쪽으로 운영할지로 나뉜다.

  - 봇용 : CPU와 메모리 리소스를 최대한 활용하는 방안으로 한다. 응답시간은 중요하지 않으므로 Load Average는 적당히 높아도 상관없다.
  - 사용자용 : CPU와 메모리 소스를 최대한 활용하기보다는 갑자기 높아질 트래픽에 대비하여 여유분을 두고 사용중인 리소스는 최대한 양호한 응답 처리하도록 한다.

- DB서버의 경우

  - 비슷한 케이스로 튜닝한다고 생각하면 된다. 사용자용 DB 서버는 전체적으로 부하를 낮게 함으로써 해당 DB 서버로의 쿼리도 가능한 한 빠르게 반환하도록 하고 봇용은 리소스를 최대한 사용하도록 한다.

> 튜닝
>
> - 부하파악
>   - 서버 관리툴 사용
> - 상태 감시
> - 부하를 가시화해서 병목이나 이상현상을 파악할 수 있도록 한다.
> - OS의 동작원리를 알고 서버 성능을 올바르게 이끌어낸다.



#### 확장성 확보에 추가로 알아둘 사항

로드밸런서를 이용하거나 파티셔닝을 이용한다.

